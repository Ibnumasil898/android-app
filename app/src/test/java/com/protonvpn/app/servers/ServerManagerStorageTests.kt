/*
 * Copyright (c) 2026. Proton AG
 *
 * This file is part of ProtonVPN.
 *
 * ProtonVPN is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * ProtonVPN is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with ProtonVPN.  If not, see <https://www.gnu.org/licenses/>.
 */

package com.protonvpn.app.servers

import android.content.SharedPreferences
import androidx.core.content.edit
import com.protonvpn.android.servers.ServersDataManager
import com.protonvpn.android.utils.ServerManager
import com.protonvpn.android.utils.Storage
import com.protonvpn.mocks.FakeUpdateServersWithBinaryStatus
import com.protonvpn.mocks.createNoopUserCountry
import com.protonvpn.test.shared.MockSharedPreference
import com.protonvpn.test.shared.TestDispatcherProvider
import com.protonvpn.test.shared.createInMemoryServersStore
import kotlinx.coroutines.ExperimentalCoroutinesApi
import kotlinx.coroutines.flow.first
import kotlinx.coroutines.test.StandardTestDispatcher
import kotlinx.coroutines.test.TestDispatcher
import kotlinx.coroutines.test.TestScope
import kotlinx.coroutines.test.currentTime
import kotlinx.coroutines.test.runTest
import org.junit.Assert.assertEquals
import org.junit.Assert.assertFalse
import org.junit.Assert.assertTrue
import org.junit.Before
import org.junit.Test

@OptIn(ExperimentalCoroutinesApi::class)
class ServerManagerStorageTests {

    private lateinit var serversDataManager: ServersDataManager
    private lateinit var storagePrefs: SharedPreferences
    private lateinit var testDispatcher: TestDispatcher
    private lateinit var testScope: TestScope

    @Before
    fun setup() {
        storagePrefs = MockSharedPreference()
        Storage.setPreferences(storagePrefs)
        testDispatcher = StandardTestDispatcher()
        testScope = TestScope(testDispatcher)

        val testDispatcherProvider = TestDispatcherProvider(testDispatcher)
        serversDataManager = ServersDataManager(
            testDispatcherProvider,
            createInMemoryServersStore(emptyList(), ""),
            FakeUpdateServersWithBinaryStatus(),
        )
    }

    @Test
    fun `restore ServerManager state from persistent storage`() = testScope.runTest {
        val jsonServerManager = """
            {"hasCountries":true,"hasDownloadedServers":true,"hasGateways":false,"lastUpdateTimestamp":1769690569069,"serverListAppVersionCode":605154709,"streamingServices":{"countryToServices":{"AU":{"2":[{"coloredIconName":"streaming/colored/netflix.png","iconName":"netflix.png","name":"Netflix"},{"coloredIconName":"streaming/colored/amazonprime.png","iconName":"amazonprime.png","name":"Amazon Prime"},{"coloredIconName":"streaming/colored/disneyplus.png","iconName":"disneyplus.png","name":"DisneyPlus"},{"coloredIconName":"streaming/colored/paramountplus.png","iconName":"paramountplus.png","name":"Paramount+"},{"coloredIconName":"streaming/colored/9now.png","iconName":"9now.png","name":"9 Now TV"},{"coloredIconName":"streaming/colored/10play.png","iconName":"10play.png","name":"10 Play"},{"coloredIconName":"streaming/colored/7plus.png","iconName":"7plus.png","name":"7 Plus"},{"coloredIconName":"streaming/colored/iview.png","iconName":"iview.png","name":"ABC iView"},{"coloredIconName":"streaming/colored/kayo-sports.png","iconName":"kayo-sports.png","name":"Kayo Sports"},{"coloredIconName":"streaming/colored/acorntv.png","iconName":"acorntv.png","name":"Acorn TV"}]},"CA":{"2":[{"coloredIconName":"streaming/colored/netflix.png","iconName":"netflix.png","name":"Netflix"},{"coloredIconName":"streaming/colored/amazonprime.png","iconName":"amazonprime.png","name":"Amazon Prime"},{"coloredIconName":"streaming/colored/disneyplus.png","iconName":"disneyplus.png","name":"DisneyPlus"},{"coloredIconName":"streaming/colored/paramountplus.png","iconName":"paramountplus.png","name":"Paramount+"},{"coloredIconName":"streaming/colored/dazn.png","iconName":"dazn.png","name":"DAZN"},{"coloredIconName":"streaming/colored/fubo.png","iconName":"fubo.png","name":"FuboTV"},{"coloredIconName":"streaming/colored/acorntv.png","iconName":"acorntv.png","name":"Acorn TV"},{"coloredIconName":"streaming/colored/britbox.png","iconName":"britbox.png","name":"Britbox"},{"coloredIconName":"streaming/colored/ctv.png","iconName":"ctv.png","name":"CTV"},{"coloredIconName":"streaming/colored/cbc-gem.png","iconName":"cbc-gem.png","name":"CBC Gem"}]},"DE":{"2":[{"coloredIconName":"streaming/colored/netflix.png","iconName":"netflix.png","name":"Netflix"},{"coloredIconName":"streaming/colored/amazonprime.png","iconName":"amazonprime.png","name":"Amazon Prime"},{"coloredIconName":"streaming/colored/disneyplus.png","iconName":"disneyplus.png","name":"DisneyPlus"},{"coloredIconName":"streaming/colored/paramountplus.png","iconName":"paramountplus.png","name":"Paramount+"},{"coloredIconName":"streaming/colored/dazn.png","iconName":"dazn.png","name":"DAZN"},{"coloredIconName":"streaming/colored/rtlplus.png","iconName":"rtlplus.png","name":"RTL+"},{"coloredIconName":"streaming/colored/ard.png","iconName":"ard.png","name":"ARD"},{"coloredIconName":"streaming/colored/zdf.png","iconName":"zdf.png","name":"ZDF"},{"coloredIconName":"streaming/colored/arte.png","iconName":"arte.png","name":"Arte"},{"coloredIconName":"streaming/colored/joyn.png","iconName":"joyn.png","name":"Joyn"}]},"FR":{"2":[{"coloredIconName":"streaming/colored/netflix.png","iconName":"netflix.png","name":"Netflix"},{"coloredIconName":"streaming/colored/amazonprime.png","iconName":"amazonprime.png","name":"Amazon Prime"},{"coloredIconName":"streaming/colored/disneyplus.png","iconName":"disneyplus.png","name":"DisneyPlus"},{"coloredIconName":"streaming/colored/paramountplus.png","iconName":"paramountplus.png","name":"Paramount+"},{"coloredIconName":"streaming/colored/max.png","iconName":"max.png","name":"Max"},{"coloredIconName":"streaming/colored/france-tv.png","iconName":"france-tv.png","name":"France TV"},{"coloredIconName":"streaming/colored/dazn.png","iconName":"dazn.png","name":"DAZN"},{"coloredIconName":"streaming/colored/tf1.png","iconName":"tf1.png","name":"TF1"},{"coloredIconName":"streaming/colored/canalplus.png","iconName":"canalplus.png","name":"Canal+"},{"coloredIconName":"streaming/colored/m6plus.png","iconName":"m6plus.png","name":"M6+"},{"coloredIconName":"streaming/colored/arte.png","iconName":"arte.png","name":"Arte"}]},"IN":{"2":[{"coloredIconName":"streaming/colored/netflix.png","iconName":"netflix.png","name":"Netflix"},{"coloredIconName":"streaming/colored/amazonprime.png","iconName":"amazonprime.png","name":"Amazon Prime"},{"coloredIconName":"streaming/colored/hotstar.png","iconName":"hotstar.png","name":"Hotstar"},{"coloredIconName":"streaming/colored/sonyliv.png","iconName":"sonyliv.png","name":"SonyLiv"},{"coloredIconName":"streaming/colored/jiocinema.png","iconName":"jiocinema.png","name":"JioCinema"},{"coloredIconName":"streaming/colored/zee5.png","iconName":"zee5.png","name":"Zee5"},{"coloredIconName":"streaming/colored/aha.png","iconName":"aha.png","name":"Aha"},{"coloredIconName":"streaming/colored/mx-player.png","iconName":"mx-player.png","name":"MX Player"},{"coloredIconName":"streaming/colored/sun-nxt.png","iconName":"sun-nxt.png","name":"Sun NXT"},{"coloredIconName":"streaming/colored/yupptv.png","iconName":"yupptv.png","name":"Yupp TV"},{"coloredIconName":"streaming/colored/shemaroome.png","iconName":"shemaroome.png","name":"ShemarooMe"}]},"IT":{"2":[{"coloredIconName":"streaming/colored/rai.png","iconName":"rai.png","name":"Rai.it"},{"coloredIconName":"streaming/colored/netflix.png","iconName":"netflix.png","name":"Netflix"},{"coloredIconName":"streaming/colored/disneyplus.png","iconName":"disneyplus.png","name":"DisneyPlus"},{"coloredIconName":"streaming/colored/amazonprime.png","iconName":"amazonprime.png","name":"Amazon Prime"},{"coloredIconName":"streaming/colored/paramountplus.png","iconName":"paramountplus.png","name":"Paramount+"},{"coloredIconName":"streaming/colored/nowtv.png","iconName":"nowtv.png","name":"NowTV"},{"coloredIconName":"streaming/colored/mediaset-play.png","iconName":"mediaset-play.png","name":"Mediaset Play"},{"coloredIconName":"streaming/colored/dazn.png","iconName":"dazn.png","name":"DAZN"}]},"JP":{"2":[{"coloredIconName":"streaming/colored/netflix.png","iconName":"netflix.png","name":"Netflix"},{"coloredIconName":"streaming/colored/amazonprime.png","iconName":"amazonprime.png","name":"Amazon Prime"},{"coloredIconName":"streaming/colored/disneyplus.png","iconName":"disneyplus.png","name":"DisneyPlus"},{"coloredIconName":"streaming/colored/dazn.png","iconName":"dazn.png","name":"DAZN"},{"coloredIconName":"streaming/colored/abema.png","iconName":"abema.png","name":"Abema"},{"coloredIconName":"streaming/colored/tver.png","iconName":"tver.png","name":"TVer"}]},"UK":{"2":[{"coloredIconName":"streaming/colored/netflix.png","iconName":"netflix.png","name":"Netflix"},{"coloredIconName":"streaming/colored/bbc.png","iconName":"bbc.png","name":"BBC iPlayer"},{"coloredIconName":"streaming/colored/disneyplus.png","iconName":"disneyplus.png","name":"DisneyPlus"},{"coloredIconName":"streaming/colored/amazonprime.png","iconName":"amazonprime.png","name":"Amazon Prime"},{"coloredIconName":"streaming/colored/paramountplus.png","iconName":"paramountplus.png","name":"Paramount+"},{"coloredIconName":"streaming/colored/channel4.png","iconName":"channel4.png","name":"Channel4"},{"coloredIconName":"streaming/colored/ITV.png","iconName":"ITV.png","name":"ITV"},{"coloredIconName":"streaming/colored/nowtv.png","iconName":"nowtv.png","name":"NowTV"},{"coloredIconName":"streaming/colored/dazn.png","iconName":"dazn.png","name":"DAZN"}]},"US":{"2":[{"coloredIconName":"streaming/colored/netflix.png","iconName":"netflix.png","name":"Netflix"},{"coloredIconName":"streaming/colored/amazonprime.png","iconName":"amazonprime.png","name":"Amazon Prime"},{"coloredIconName":"streaming/colored/disneyplus.png","iconName":"disneyplus.png","name":"DisneyPlus"},{"coloredIconName":"streaming/colored/paramountplus.png","iconName":"paramountplus.png","name":"Paramount+"},{"coloredIconName":"streaming/colored/espnplus.png","iconName":"espnplus.png","name":"ESPN"},{"coloredIconName":"streaming/colored/f1tv.png","iconName":"f1tv.png","name":"Formula1 TV"},{"coloredIconName":"streaming/colored/fubo.png","iconName":"fubo.png","name":"FuboTV"},{"coloredIconName":"streaming/colored/abc.png","iconName":"abc.png","name":"ABC Go"},{"coloredIconName":"streaming/colored/max.png","iconName":"max.png","name":"Max"},{"coloredIconName":"streaming/colored/hulu.png","iconName":"hulu.png","name":"Hulu"},{"coloredIconName":"streaming/colored/pluto.png","iconName":"pluto.png","name":"Pluto TV"},{"coloredIconName":"streaming/colored/sling.png","iconName":"sling.png","name":"Sling TV"},{"coloredIconName":"streaming/colored/SyFy.png","iconName":"SyFy.png","name":"SyFy"},{"coloredIconName":"streaming/colored/cbs.png","iconName":"cbs.png","name":"CBS"},{"coloredIconName":"streaming/colored/peacock.png","iconName":"peacock.png","name":"Peacock TV"},{"coloredIconName":"streaming/colored/youtubetv.png","iconName":"youtubetv.png","name":"YouTube TV"},{"coloredIconName":"streaming/colored/crunchyroll.png","iconName":"crunchyroll.png","name":"Crunchyroll"},{"coloredIconName":"streaming/colored/mlb.png","iconName":"mlb.png","name":"MLB TV"},{"coloredIconName":"streaming/colored/vix.png","iconName":"vix.png","name":"Vix"},{"coloredIconName":"streaming/colored/audible.png","iconName":"audible.png","name":"Audible"},{"coloredIconName":"streaming/colored/spotify.png","iconName":"spotify.png","name":"Spotify"},{"coloredIconName":"streaming/colored/dazn.png","iconName":"dazn.png","name":"DAZN"},{"coloredIconName":"streaming/colored/acorntv.png","iconName":"acorntv.png","name":"Acorn TV"},{"coloredIconName":"streaming/colored/britbox.png","iconName":"britbox.png","name":"Britbox"},{"coloredIconName":"streaming/colored/hallmarkplus.png","iconName":"hallmarkplus.png","name":"Hallmark+"},{"coloredIconName":"streaming/colored/mgmplus.png","iconName":"mgmplus.png","name":"MGM+"},{"coloredIconName":"streaming/colored/philo.png","iconName":"philo.png","name":"Philo"}]},"CH":{"2":[{"coloredIconName":"streaming/colored/netflix.png","iconName":"netflix.png","name":"Netflix"},{"coloredIconName":"streaming/colored/amazonprime.png","iconName":"amazonprime.png","name":"Amazon Prime"},{"coloredIconName":"streaming/colored/disneyplus.png","iconName":"disneyplus.png","name":"DisneyPlus"},{"coloredIconName":"streaming/colored/paramountplus.png","iconName":"paramountplus.png","name":"Paramount+"},{"coloredIconName":"streaming/colored/srf-rts-rsi.png","iconName":"srf-rts-rsi.png","name":"SRF RTS RSI"},{"coloredIconName":"streaming/colored/dazn.png","iconName":"dazn.png","name":"DAZN"},{"coloredIconName":"streaming/colored/blick.png","iconName":"blick.png","name":"Blick TV"},{"coloredIconName":"streaming/colored/canalplus.png","iconName":"canalplus.png","name":"Canal+"}]},"ES":{"2":[{"coloredIconName":"streaming/colored/netflix.png","iconName":"netflix.png","name":"Netflix"},{"coloredIconName":"streaming/colored/amazonprime.png","iconName":"amazonprime.png","name":"Amazon Prime"},{"coloredIconName":"streaming/colored/disneyplus.png","iconName":"disneyplus.png","name":"DisneyPlus"},{"coloredIconName":"streaming/colored/max.png","iconName":"max.png","name":"Max"},{"coloredIconName":"streaming/colored/dazn.png","iconName":"dazn.png","name":"DAZN"},{"coloredIconName":"streaming/colored/atresplayer.png","iconName":"atresplayer.png","name":"Atresplayer"},{"coloredIconName":"streaming/colored/rtve-play.png","iconName":"rtve-play.png","name":"RTVE Play"},{"coloredIconName":"streaming/colored/mitele.png","iconName":"mitele.png","name":"Mitele"},{"coloredIconName":"streaming/colored/movistar-plus.png","iconName":"movistar-plus.png","name":"Movistar Plus"}]},"KR":{"2":[{"coloredIconName":"streaming/colored/netflix.png","iconName":"netflix.png","name":"Netflix"},{"coloredIconName":"streaming/colored/wavve.png","iconName":"wavve.png","name":"Wavve"}]},"PL":{"2":[{"coloredIconName":"streaming/colored/netflix.png","iconName":"netflix.png","name":"Netflix"},{"coloredIconName":"streaming/colored/amazonprime.png","iconName":"amazonprime.png","name":"Amazon Prime"},{"coloredIconName":"streaming/colored/disneyplus.png","iconName":"disneyplus.png","name":"DisneyPlus"},{"coloredIconName":"streaming/colored/max.png","iconName":"max.png","name":"Max"},{"coloredIconName":"streaming/colored/dazn.png","iconName":"dazn.png","name":"DAZN"}]},"NL":{"2":[{"coloredIconName":"streaming/colored/netflix.png","iconName":"netflix.png","name":"Netflix"},{"coloredIconName":"streaming/colored/max.png","iconName":"max.png","name":"Max"},{"coloredIconName":"streaming/colored/ziggo-go.png","iconName":"ziggo-go.png","name":"Ziggo Go"}]},"FI":{"2":[{"coloredIconName":"streaming/colored/max.png","iconName":"max.png","name":"Max"},{"coloredIconName":"streaming/colored/yle-areena.png","iconName":"yle-areena.png","name":"Yle Areena"},{"coloredIconName":"streaming/colored/mtv-katsomo.png","iconName":"mtv-katsomo.png","name":"MTV Katsomo"},{"coloredIconName":"streaming/colored/ruutu.png","iconName":"ruutu.png","name":"Ruutu"}]},"RO":{"2":[{"coloredIconName":"streaming/colored/netflix.png","iconName":"netflix.png","name":"Netflix"},{"coloredIconName":"streaming/colored/max.png","iconName":"max.png","name":"Max"}]},"BR":{"2":[{"coloredIconName":"streaming/colored/netflix.png","iconName":"netflix.png","name":"Netflix"},{"coloredIconName":"streaming/colored/amazonprime.png","iconName":"amazonprime.png","name":"Amazon Prime"},{"coloredIconName":"streaming/colored/disneyplus.png","iconName":"disneyplus.png","name":"DisneyPlus"},{"coloredIconName":"streaming/colored/paramountplus.png","iconName":"paramountplus.png","name":"Paramount+"},{"coloredIconName":"streaming/colored/max.png","iconName":"max.png","name":"Max"}]},"BE":{"2":[{"coloredIconName":"streaming/colored/netflix.png","iconName":"netflix.png","name":"Netflix"},{"coloredIconName":"streaming/colored/max.png","iconName":"max.png","name":"Max"},{"coloredIconName":"streaming/colored/rtbf-auvio.png","iconName":"rtbf-auvio.png","name":"RTBF Auvio"}]},"AR":{"2":[{"coloredIconName":"streaming/colored/netflix.png","iconName":"netflix.png","name":"Netflix"},{"coloredIconName":"streaming/colored/amazonprime.png","iconName":"amazonprime.png","name":"Amazon Prime"},{"coloredIconName":"streaming/colored/disneyplus.png","iconName":"disneyplus.png","name":"DisneyPlus"},{"coloredIconName":"streaming/colored/paramountplus.png","iconName":"paramountplus.png","name":"Paramount+"},{"coloredIconName":"streaming/colored/max.png","iconName":"max.png","name":"Max"}]},"HK":{"2":[{"coloredIconName":"streaming/colored/netflix.png","iconName":"netflix.png","name":"Netflix"}]},"CZ":{"2":[{"coloredIconName":"streaming/colored/amazonprime.png","iconName":"amazonprime.png","name":"Amazon Prime"},{"coloredIconName":"streaming/colored/disneyplus.png","iconName":"disneyplus.png","name":"DisneyPlus"},{"coloredIconName":"streaming/colored/max.png","iconName":"max.png","name":"Max"},{"coloredIconName":"streaming/colored/dazn.png","iconName":"dazn.png","name":"DAZN"}]},"NZ":{"2":[{"coloredIconName":"streaming/colored/netflix.png","iconName":"netflix.png","name":"Netflix"},{"coloredIconName":"streaming/colored/acorntv.png","iconName":"acorntv.png","name":"Acorn TV"},{"coloredIconName":"streaming/colored/tvnzplus.png","iconName":"tvnzplus.png","name":"TVNZ+"},{"coloredIconName":"streaming/colored/threenow.png","iconName":"threenow.png","name":"ThreeNow"}]},"NO":{"2":[{"coloredIconName":"streaming/colored/amazonprime.png","iconName":"amazonprime.png","name":"Amazon Prime"},{"coloredIconName":"streaming/colored/disneyplus.png","iconName":"disneyplus.png","name":"DisneyPlus"},{"coloredIconName":"streaming/colored/max.png","iconName":"max.png","name":"Max"},{"coloredIconName":"streaming/colored/dazn.png","iconName":"dazn.png","name":"DAZN"},{"coloredIconName":"streaming/colored/nrk.png","iconName":"nrk.png","name":"NRK"}]},"SE":{"2":[{"coloredIconName":"streaming/colored/netflix.png","iconName":"netflix.png","name":"Netflix"},{"coloredIconName":"streaming/colored/max.png","iconName":"max.png","name":"Max"},{"coloredIconName":"streaming/colored/svt-play.png","iconName":"svt-play.png","name":"SVT Play"},{"coloredIconName":"streaming/colored/tv4-play.png","iconName":"tv4-play.png","name":"TV4 Play"}]},"ZA":{"2":[{"coloredIconName":"streaming/colored/netflix.png","iconName":"netflix.png","name":"Netflix"},{"coloredIconName":"streaming/colored/dstv.png","iconName":"dstv.png","name":"DStv"}]},"MX":{"2":[{"coloredIconName":"streaming/colored/netflix.png","iconName":"netflix.png","name":"Netflix"},{"coloredIconName":"streaming/colored/amazonprime.png","iconName":"amazonprime.png","name":"Amazon Prime"},{"coloredIconName":"streaming/colored/disneyplus.png","iconName":"disneyplus.png","name":"DisneyPlus"},{"coloredIconName":"streaming/colored/paramountplus.png","iconName":"paramountplus.png","name":"Paramount+"},{"coloredIconName":"streaming/colored/max.png","iconName":"max.png","name":"Max"}]},"DK":{"2":[{"coloredIconName":"streaming/colored/max.png","iconName":"max.png","name":"Max"},{"coloredIconName":"streaming/colored/drtv.png","iconName":"drtv.png","name":"DRTV"}]},"TR":{"2":[{"coloredIconName":"streaming/colored/netflix.png","iconName":"netflix.png","name":"Netflix"}]},"PT":{"2":[{"coloredIconName":"streaming/colored/netflix.png","iconName":"netflix.png","name":"Netflix"},{"coloredIconName":"streaming/colored/max.png","iconName":"max.png","name":"Max"}]},"AT":{"2":[{"coloredIconName":"streaming/colored/amazonprime.png","iconName":"amazonprime.png","name":"Amazon Prime"},{"coloredIconName":"streaming/colored/disneyplus.png","iconName":"disneyplus.png","name":"DisneyPlus"},{"coloredIconName":"streaming/colored/paramountplus.png","iconName":"paramountplus.png","name":"Paramount+"},{"coloredIconName":"streaming/colored/servustv.png","iconName":"servustv.png","name":"ServusTV"},{"coloredIconName":"streaming/colored/orf-on.png","iconName":"orf-on.png","name":"ORF On"}]},"LT":{"2":[{"coloredIconName":"streaming/colored/netflix.png","iconName":"netflix.png","name":"Netflix"},{"coloredIconName":"streaming/colored/go3.png","iconName":"go3.png","name":"Go3"},{"coloredIconName":"streaming/colored/tv3-play.png","iconName":"tv3-play.png","name":"TV3 Play"}]},"SK":{"2":[{"coloredIconName":"streaming/colored/netflix.png","iconName":"netflix.png","name":"Netflix"},{"coloredIconName":"streaming/colored/max.png","iconName":"max.png","name":"Max"}]},"UA":{"2":[{"coloredIconName":"streaming/colored/netflix.png","iconName":"netflix.png","name":"Netflix"}]},"CO":{"2":[{"coloredIconName":"streaming/colored/amazonprime.png","iconName":"amazonprime.png","name":"Amazon Prime"},{"coloredIconName":"streaming/colored/disneyplus.png","iconName":"disneyplus.png","name":"DisneyPlus"},{"coloredIconName":"streaming/colored/paramountplus.png","iconName":"paramountplus.png","name":"Paramount+"},{"coloredIconName":"streaming/colored/max.png","iconName":"max.png","name":"Max"}]},"CL":{"2":[{"coloredIconName":"streaming/colored/amazonprime.png","iconName":"amazonprime.png","name":"Amazon Prime"},{"coloredIconName":"streaming/colored/disneyplus.png","iconName":"disneyplus.png","name":"DisneyPlus"},{"coloredIconName":"streaming/colored/paramountplus.png","iconName":"paramountplus.png","name":"Paramount+"},{"coloredIconName":"streaming/colored/max.png","iconName":"max.png","name":"Max"}]},"PE":{"2":[{"coloredIconName":"streaming/colored/amazonprime.png","iconName":"amazonprime.png","name":"Amazon Prime"},{"coloredIconName":"streaming/colored/disneyplus.png","iconName":"disneyplus.png","name":"DisneyPlus"},{"coloredIconName":"streaming/colored/paramountplus.png","iconName":"paramountplus.png","name":"Paramount+"},{"coloredIconName":"streaming/colored/max.png","iconName":"max.png","name":"Max"}]},"CR":{"2":[{"coloredIconName":"streaming/colored/amazonprime.png","iconName":"amazonprime.png","name":"Amazon Prime"},{"coloredIconName":"streaming/colored/disneyplus.png","iconName":"disneyplus.png","name":"DisneyPlus"},{"coloredIconName":"streaming/colored/paramountplus.png","iconName":"paramountplus.png","name":"Paramount+"},{"coloredIconName":"streaming/colored/max.png","iconName":"max.png","name":"Max"}]},"MY":{"2":[{"coloredIconName":"streaming/colored/netflix.png","iconName":"netflix.png","name":"Netflix"}]},"PH":{"2":[{"coloredIconName":"streaming/colored/netflix.png","iconName":"netflix.png","name":"Netflix"}]},"BG":{"2":[{"coloredIconName":"streaming/colored/max.png","iconName":"max.png","name":"Max"}]},"HR":{"2":[{"coloredIconName":"streaming/colored/max.png","iconName":"max.png","name":"Max"}]},"MK":{"2":[{"coloredIconName":"streaming/colored/max.png","iconName":"max.png","name":"Max"},{"coloredIconName":"streaming/colored/gley.png","iconName":"gley.png","name":"Gley"}]},"RS":{"2":[{"coloredIconName":"streaming/colored/max.png","iconName":"max.png","name":"Max"}]},"SI":{"2":[{"coloredIconName":"streaming/colored/max.png","iconName":"max.png","name":"Max"}]},"HU":{"2":[{"coloredIconName":"streaming/colored/max.png","iconName":"max.png","name":"Max"}]},"MD":{"2":[{"coloredIconName":"streaming/colored/max.png","iconName":"max.png","name":"Max"}]},"EC":{"2":[{"coloredIconName":"streaming/colored/max.png","iconName":"max.png","name":"Max"}]},"SV":{"2":[{"coloredIconName":"streaming/colored/max.png","iconName":"max.png","name":"Max"}]},"VE":{"2":[{"coloredIconName":"streaming/colored/max.png","iconName":"max.png","name":"Max"}]},"IE":{"2":[{"coloredIconName":"streaming/colored/rte-player.png","iconName":"rte-player.png","name":"RTE Player"},{"coloredIconName":"streaming/colored/tg4.png","iconName":"tg4.png","name":"TG4"}]},"RU":{"2":[{"coloredIconName":"streaming/colored/kinopoisk.png","iconName":"kinopoisk.png","name":"Kinopoisk"},{"coloredIconName":"streaming/colored/ivi.png","iconName":"ivi.png","name":"Ivi"}]},"*":{"2":[{"coloredIconName":"streaming/colored/bbc.png","iconName":"bbc.png","name":"BBC iPlayer"}]}},"resourceBaseURL":"https://protonvpn.com/download/resources/"}}
        """.trimIndent()
        storagePrefs.edit {
            putString("com.protonvpn.android.utils.ServerManager", jsonServerManager)
        }
        val serverManager = ServerManager(
            mainScope = testScope.backgroundScope,
            wallClock = testScope::currentTime,
            serversData = serversDataManager,
            createNoopUserCountry(),
        )

        assertTrue(serverManager.isDownloadedAtLeastOnce)
        assertEquals(1769690569069L, serverManager.lastUpdateTimestamp)
        assertTrue(serverManager.hasCountriesFlow.first())
        assertFalse(serverManager.hasGatewaysFlow.first())
    }
}